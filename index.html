<!DOCTYPE html>
<html>
<head>
    <script
            src="https://js.jotform.com/JotFormCustomWidget.min.js"
            crossorigin="anonymous"
    ></script>
</head>
<body>
<script type="text/javascript">
    // Debounce function to limit API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Store the latest values
    let latestAddress = localStorage.getItem("addressNumber") || "";
    let latestUnitNumber = localStorage.getItem("unitNumber") || "";
    let isAddressChanged = false;
    let isCityChanged = false;
    let isPostalChanged = false;
    let isUnitChanged = false;

    function sendFullAddress() {
        function getBestFingerprintSync() {
            try {
                // Canvas fingerprint (same as above but inline)
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 300;
                canvas.height = 150;

                const gradient = ctx.createRadialGradient(75, 75, 0, 75, 75, 75);
                gradient.addColorStop(0, '#ff0000');
                gradient.addColorStop(0.5, 'rgba(0, 255, 0, 0.7)');
                gradient.addColorStop(1, '#0000ff');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 150, 150);

                ['Arial', 'Georgia', 'Times', 'Courier', 'Verdana'].forEach((font, i) => {
                    ctx.font = `${12 + i * 2}px ${font}`;
                    ctx.fillStyle = `hsl(${i * 72}, 70%, 50%)`;
                    ctx.fillText(['Hello ðŸŒŸ', 'Î±Î²Î³Î´Îµ', 'Test123!', 'ä¸­æ–‡', 'ðŸš€ðŸŽ¨'][i] || 'Test', 10, 25 + i * 18);
                });

                ctx.globalCompositeOperation = 'multiply';
                ctx.fillStyle = 'rgba(255, 0, 255, 0.6)';
                ctx.beginPath();
                ctx.arc(200, 75, 30, 0, Math.PI * 2);
                ctx.fill();

                const canvasData = canvas.toDataURL();

                // Combine components
                const components = [
                    navigator.userAgent,
                    `${screen.width}x${screen.height}x${screen.colorDepth}x${window.devicePixelRatio || 1}`,
                    new Date().getTimezoneOffset() + '|' + Intl.DateTimeFormat().resolvedOptions().timeZone,
                    (navigator.languages || [navigator.language]).join(','),
                    navigator.hardwareConcurrency || 'unknown',
                    canvasData,
                    Date.now(),
                    Math.random().toString(36).substring(2, 15)
                ];

                // Simple hash for synchronous operation
                let hash = 0;
                const str = components.join('###');
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }

                return Math.abs(hash).toString(16) + Date.now().toString(36);
            } catch (error) {
                return 'error-' + Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
            }
        }

        const deviceId = getBestFingerprintSync();
        console.log(deviceId, 'deviceId v1 upload')
        const submitData = { address: latestAddress, unitNumber: isUnitChanged ? latestUnitNumber : isAddressChanged && isCityChanged && isPostalChanged ? '' : latestUnitNumber, deviceId: deviceId }
        fetch('https://getaddressinfofromjotform.netlify.app/.netlify/functions/dropbox-new-storage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(submitData)
        })
            .then(res => res.json())
            .then(data => console.log('Address+Unit sent:', data))
            .catch(err => console.error('Error sending address+unit:', err));
        fetch('https://getaddressinfofromjotform.netlify.app/.netlify/functions/dropbox-storage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(submitData)
        })
            .then(res => res.json())
            .then(data => console.log('Address+Unit sent:', data))
            .catch(err => console.error('Error sending address+unit:', err));
    }

    const debouncedSendFullAddress = debounce(sendFullAddress, 500);

    JFCustomWidget.subscribe("ready", function () {
        console.log("address => start .. v2");
        function getDeviceId() {
            const STORAGE_KEY = 'device_unique_id';

            // Check if ID already exists
            let deviceId = localStorage.getItem(STORAGE_KEY);

            if (!deviceId) {
                // Generate a new unique ID using device characteristics + random component
                const fingerprint = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen: `${screen.width}x${screen.height}`
                };

                // Create hash from fingerprint data
                const fingerprintString = JSON.stringify(fingerprint);
                deviceId = 'dev_' + fingerprintString
            }

            return deviceId;
        }

        const deviceId = getDeviceId();
        console.log('Your device ID address:', deviceId);

        JFCustomWidget.listenFromField(
            "input_10_addr_line1",
            "keyup",
            function (value) {
                isAddressChanged = true;
                console.log("ADDRESS1 key up:", value);
                localStorage.setItem("addressNumber", value);
                latestAddress = value;
                debouncedSendFullAddress();
            }
        );
        JFCustomWidget.listenFromField(
            "input_10_addr_line2",
            "keyup",
            function (value) {
                isUnitChanged = true;
                console.log("addr2 key up:", value);
                localStorage.setItem("unitNumber", value);
                latestUnitNumber = value;
                debouncedSendFullAddress();
            }
        );

        JFCustomWidget.listenFromField(
            "input_10_city",
            "keyup",
            function (value) {
                isCityChanged = true
                localStorage.setItem("city", value);
                debouncedSendFullAddress();
            }
        );
        JFCustomWidget.listenFromField(
            "input_10_postal",
            "keyup",
            function (value) {
                isPostalChanged = true
                localStorage.setItem("postal", value);
                debouncedSendFullAddress();
            }
        );
    });

</script>
</body>
</html>
