<!DOCTYPE html>
<html>
<head>
    <script
            src="https://js.jotform.com/JotFormCustomWidget.min.js"
            crossorigin="anonymous"
    ></script>
</head>
<body>
<script type="text/javascript">
    // Debounce function to limit API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Store the latest values - initialize as empty strings
    let latestAddress = "";
    let latestUnitNumber = "";
    let isAddressChanged = false;
    let isUnitChanged = false;
    let isInitialized = false;

    function sendFullAddress() {
        // Only send data if there have been actual changes after initialization
        if (!isInitialized) {
            console.log('Not initialized yet, skipping send');
            return;
        }

        const submitData = {};

        // Send address if it has changed (even if empty)
        if (isAddressChanged) {
            submitData.address = latestAddress;
        }

        // Send unit number if it has changed (even if empty)
        if (isUnitChanged) {
            submitData.unitNumber = latestUnitNumber;
        }

        // Only send if there's actually data to send
        if (Object.keys(submitData).length === 0) {
            console.log('No changes to send');
            return;
        }

        console.log('Sending data:', submitData);

        fetch('https://getaddressinfofromjotform.netlify.app/.netlify/functions/dropbox-storage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(submitData)
        })
            .then(res => res.json())
            .then(data => console.log('Address+Unit sent:', data))
            .catch(err => console.error('Error sending address+unit:', err));
    }

    const debouncedSendFullAddress = debounce(sendFullAddress, 500);

    JFCustomWidget.subscribe("ready", function (value) {
        console.log("address => start .. v3");
        console.log(value);

        // Clear any existing localStorage on initialization to start fresh
        localStorage.removeItem("addressNumber");
        localStorage.removeItem("unitNumber");

        // Mark as initialized after a short delay to avoid sending data on page load
        setTimeout(() => {
            isInitialized = true;
            console.log('Widget initialized, ready to track changes');
        }, 1000);

        JFCustomWidget.listenFromField(
            "input_10_addr_line1",
            "keyup",
            function (value) {
                const cleanValue = value || "";

                // Only process if initialized and value actually changed
                if (isInitialized && latestAddress !== cleanValue) {
                    isAddressChanged = true;
                    console.log("ADDRESS1 key up:", cleanValue);

                    if (cleanValue === "") {
                        localStorage.removeItem("addressNumber");
                    } else {
                        localStorage.setItem("addressNumber", cleanValue);
                    }

                    latestAddress = cleanValue;
                    debouncedSendFullAddress();
                } else if (!isInitialized) {
                    // Just update the tracking variable during initialization
                    latestAddress = cleanValue;
                }
            }
        );

        JFCustomWidget.listenFromField(
            "input_10_addr_line2",
            "keyup",
            function (value) {
                const cleanValue = value || "";

                // Only process if initialized and value actually changed
                if (isInitialized && latestUnitNumber !== cleanValue) {
                    isUnitChanged = true;
                    console.log("addr2 key up:", cleanValue);

                    if (cleanValue === "") {
                        localStorage.removeItem("unitNumber");
                    } else {
                        localStorage.setItem("unitNumber", cleanValue);
                    }

                    latestUnitNumber = cleanValue;
                    debouncedSendFullAddress();
                } else if (!isInitialized) {
                    // Just update the tracking variable during initialization
                    latestUnitNumber = cleanValue;
                }
            }
        );
    });
</script>
</body>
</html>
