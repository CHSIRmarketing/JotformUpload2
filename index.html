<!DOCTYPE html>
<html>
<head>
    <script
            src="https://js.jotform.com/JotFormCustomWidget.min.js"
            crossorigin="anonymous"
    ></script>
</head>
<body>
<script type="text/javascript">
    // Debounce function to limit API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Store the latest values
    let latestAddress = localStorage.getItem("addressNumber") || "";
    let latestUnitNumber = localStorage.getItem("unitNumber") || "";
    let isAddressChanged = false;
    let isCityChanged = false;
    let isPostalChanged = false;
    let isUnitChanged = false;

    function sendFullAddress() {
        function getDeviceId() {
            const STORAGE_KEY = 'device_unique_id';

            // Check if ID already exists
            let deviceId = localStorage.getItem(STORAGE_KEY);

            if (!deviceId) {
                // Generate a new unique ID using device characteristics + random component
                const fingerprint = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen: `${screen.width}x${screen.height}`
                };

                // Create hash from fingerprint data
                const fingerprintString = `${fingerprint.userAgent}${fingerprint.language}${fingerprint.hardwareConcurrency}${fingerprint.timezone}${fingerprint.screen}`;
                deviceId = 'dev_' + fingerprintString.replaceAll(' ', '-')
            }

            return deviceId;
        }

        const deviceId = getDeviceId();
        const submitData = { address: latestAddress, unitNumber: isUnitChanged ? latestUnitNumber : isAddressChanged && isCityChanged && isPostalChanged ? '' : latestUnitNumber, deviceId: deviceId }
        fetch('https://getaddressinfofromjotform.netlify.app/.netlify/functions/dropbox-new-storage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(submitData)
        })
            .then(res => res.json())
            .then(data => console.log('Address+Unit sent:', data))
            .catch(err => console.error('Error sending address+unit:', err));
        fetch('https://getaddressinfofromjotform.netlify.app/.netlify/functions/dropbox-storage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(submitData)
        })
            .then(res => res.json())
            .then(data => console.log('Address+Unit sent:', data))
            .catch(err => console.error('Error sending address+unit:', err));
    }

    const debouncedSendFullAddress = debounce(sendFullAddress, 500);

    JFCustomWidget.subscribe("ready", function () {
        console.log("address => start .. v1");
        function getDeviceId() {
            const STORAGE_KEY = 'device_unique_id';

            // Check if ID already exists
            let deviceId = localStorage.getItem(STORAGE_KEY);

            if (!deviceId) {
                // Generate a new unique ID using device characteristics + random component
                const fingerprint = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    screen: `${screen.width}x${screen.height}`
                };

                // Create hash from fingerprint data
                const fingerprintString = JSON.stringify(fingerprint);
                deviceId = 'dev_' + fingerprintString
            }

            return deviceId;
        }

        const deviceId = getDeviceId();
        console.log('Your device ID address:', deviceId);

        JFCustomWidget.listenFromField(
            "input_10_addr_line1",
            "keyup",
            function (value) {
                isAddressChanged = true;
                console.log("ADDRESS1 key up:", value);
                localStorage.setItem("addressNumber", value);
                latestAddress = value;
                debouncedSendFullAddress();
            }
        );
        JFCustomWidget.listenFromField(
            "input_10_addr_line2",
            "keyup",
            function (value) {
                isUnitChanged = true;
                console.log("addr2 key up:", value);
                localStorage.setItem("unitNumber", value);
                latestUnitNumber = value;
                debouncedSendFullAddress();
            }
        );

        JFCustomWidget.listenFromField(
            "input_10_city",
            "keyup",
            function (value) {
                isCityChanged = true
                localStorage.setItem("city", value);
                debouncedSendFullAddress();
            }
        );
        JFCustomWidget.listenFromField(
            "input_10_postal",
            "keyup",
            function (value) {
                isPostalChanged = true
                localStorage.setItem("postal", value);
                debouncedSendFullAddress();
            }
        );
    });

</script>
</body>
</html>
